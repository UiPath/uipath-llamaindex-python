name: Discover Testcases

on:
  workflow_call:
    outputs:
      testcases:
        description: "JSON array of discovered testcases with package and testcase info"
        value: ${{ jobs.discover-testcases.outputs.testcases }}

permissions:
  contents: read

jobs:
  discover-testcases:
    runs-on: ubuntu-latest
    outputs:
      testcases: ${{ steps.discover.outputs.testcases }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Discover testcases
      id: discover
      run: |
        # Find all packages with testcases directories
        testcases_array="[]"

        for package_dir in packages/*/testcases; do
          if [ -d "$package_dir" ]; then
            package_name=$(echo "$package_dir" | sed 's|packages/\(.*\)/testcases|\1|')
            echo "Discovering testcases in $package_name"

            # Find all testcase folders in this package
            for testcase_dir in "$package_dir"/*-*; do
              if [ -d "$testcase_dir" ]; then
                testcase_name=$(basename "$testcase_dir")
                echo "  Found: $testcase_name"

                # Add to JSON array with package and testcase info
                testcases_array=$(echo "$testcases_array" | jq -c ". += [{\"package\": \"$package_name\", \"testcase\": \"$testcase_name\"}]")
              fi
            done
          fi
        done

        echo "Testcases matrix: $testcases_array"
        echo "testcases=$testcases_array" >> $GITHUB_OUTPUT
