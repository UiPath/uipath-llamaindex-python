name: Discover Packages

on:
  workflow_call:
    outputs:
      packages:
        description: "JSON array of discovered package names"
        value: ${{ jobs.discover-packages.outputs.packages }}

permissions:
  contents: read

jobs:
  discover-packages:
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.discover.outputs.packages }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Discover packages
      id: discover
      run: |
        # Find all packages with pyproject.toml
        packages_array="[]"

        for package_dir in packages/*/pyproject.toml; do
          if [ -f "$package_dir" ]; then
            package_name=$(echo "$package_dir" | sed 's|packages/\(.*\)/pyproject.toml|\1|')
            echo "Found package: $package_name"
            packages_array=$(echo "$packages_array" | jq -c ". += [\"$package_name\"]")
          fi
        done

        echo "Packages: $packages_array"
        echo "packages=$packages_array" >> $GITHUB_OUTPUT
